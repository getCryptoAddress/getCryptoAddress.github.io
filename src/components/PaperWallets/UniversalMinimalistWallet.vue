<script setup lang="ts">
import { computed, ref, watch } from "vue";
import QRCode from "qrcode";

const props = defineProps<{
  secret: string;
  address: string;
}>();

const QRAddress = ref("");
watch(
  () => props.address,
  async (secret) => {
    QRAddress.value = await QRCode.toDataURL(secret);
  },
  { immediate: true }
);
const QRSecret = ref("");
watch(
  () => props.secret,
  async (secret) => {
    QRSecret.value = await QRCode.toDataURL(secret);
  },
  { immediate: true }
);

// todo move to utils and add tests
function wrapText(text: string, maxWidth: number, fontSize: number) {
  const charsPerLine = Math.floor(maxWidth / fontSize);
  const lines = [];

  for (let i = 0; i < text.length; i += charsPerLine) {
    const line = text.slice(i, i + charsPerLine);
    lines.push(line);
  }
  return lines;
}

// todo move to utils and add tests
function generateTextSVG(
  text: string,
  startYPosition: number,
  startXPosition: number,
  maxWidth: number,
  fontSize: number,
  fill: string
) {
  const lineHeight = fontSize * 1.2;
  const lines = wrapText(text, maxWidth, fontSize);
  return lines
    .map((line, i) => {
      const y = startYPosition + i * lineHeight;
      return `<text
        fill="#414141"
        x="${startXPosition}"
        y="${y}"
        font-family="Inter"
        font-size="${fontSize}"
        fill="${fill}"
      >
        ${line}
      </text>`;
    })
    .join("");
}

const secretSVG = computed(() =>
  generateTextSVG(props.secret, 185, 18, 200, 10, "#414141")
);
const addressSVG = computed(() =>
  generateTextSVG(props.address, 185, 348, 200, 10, "#414141")
);
</script>
<template>
  <svg
    width="480"
    height="260"
    viewBox="0 0 480 260"
    fill="#FFFFFF"
    xmlns="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    style="max-width: 100%; height: auto"
  >
    <text
      x="40"
      y="40"
      font-family="Inter"
      font-size="20"
      fill="#414141"
      font-weight="bold"
    >
      Secret
    </text>
    <rect x="20" y="54" width="110" height="110" fill="url(#pattern0)" />
    <g v-html="secretSVG" />
    <path
      d="M197.299 48V29.0909H204.87C206.261 29.0909 207.421 29.2971 208.351 29.7095C209.28 30.1219 209.979 30.6944 210.446 31.4268C210.914 32.1532 211.148 32.9903 211.148 33.9382C211.148 34.6768 211 35.3262 210.705 35.8864C210.41 36.4403 210.003 36.8958 209.486 37.2528C208.975 37.6037 208.391 37.853 207.732 38.0007V38.1854C208.452 38.2161 209.126 38.4193 209.754 38.7947C210.388 39.1702 210.902 39.6965 211.296 40.3736C211.69 41.0445 211.887 41.8447 211.887 42.7741C211.887 43.7775 211.638 44.6731 211.139 45.4609C210.647 46.2427 209.917 46.8613 208.951 47.3168C207.984 47.7723 206.793 48 205.378 48H197.299ZM201.297 44.7315H204.556C205.67 44.7315 206.482 44.5192 206.993 44.0945C207.504 43.6636 207.76 43.0911 207.76 42.3771C207.76 41.8539 207.633 41.3923 207.381 40.9922C207.129 40.5921 206.769 40.2782 206.301 40.0504C205.839 39.8227 205.288 39.7088 204.648 39.7088H201.297V44.7315ZM201.297 37.0036H204.26C204.808 37.0036 205.294 36.9081 205.719 36.7173C206.15 36.5204 206.489 36.2434 206.735 35.8864C206.987 35.5294 207.113 35.1016 207.113 34.603C207.113 33.9197 206.87 33.3688 206.384 32.9503C205.904 32.5317 205.221 32.3224 204.334 32.3224H201.297V37.0036ZM214.414 48V33.8182H218.348V48H214.414ZM216.39 31.9901C215.805 31.9901 215.304 31.7962 214.885 31.4084C214.473 31.0144 214.267 30.5436 214.267 29.9957C214.267 29.4541 214.473 28.9893 214.885 28.6016C215.304 28.2076 215.805 28.0107 216.39 28.0107C216.975 28.0107 217.474 28.2076 217.886 28.6016C218.304 28.9893 218.514 29.4541 218.514 29.9957C218.514 30.5436 218.304 31.0144 217.886 31.4084C217.474 31.7962 216.975 31.9901 216.39 31.9901ZM229.042 33.8182V36.7727H220.501V33.8182H229.042ZM222.44 30.4205H226.373V43.642C226.373 44.0052 226.429 44.2884 226.54 44.4915C226.65 44.6884 226.804 44.8269 227.001 44.907C227.204 44.987 227.438 45.027 227.703 45.027C227.888 45.027 228.072 45.0116 228.257 44.9808C228.441 44.9439 228.583 44.9162 228.682 44.8977L229.3 47.8246C229.103 47.8861 228.826 47.9569 228.469 48.0369C228.112 48.1231 227.678 48.1754 227.167 48.1939C226.219 48.2308 225.388 48.1046 224.674 47.8153C223.967 47.526 223.416 47.0767 223.022 46.4673C222.628 45.858 222.434 45.0885 222.44 44.1591V30.4205ZM237.859 48.277C236.406 48.277 235.157 47.9692 234.111 47.3537C233.07 46.732 232.27 45.8703 231.71 44.7685C231.156 43.6667 230.879 42.3987 230.879 40.9645C230.879 39.5118 231.159 38.2377 231.719 37.142C232.285 36.0402 233.089 35.1816 234.129 34.5661C235.169 33.9444 236.406 33.6335 237.841 33.6335C239.078 33.6335 240.161 33.8582 241.091 34.3075C242.02 34.7569 242.756 35.3878 243.297 36.2003C243.839 37.0128 244.138 37.9669 244.193 39.0625H240.481C240.377 38.3546 240.1 37.7853 239.65 37.3544C239.207 36.9174 238.625 36.6989 237.905 36.6989C237.296 36.6989 236.763 36.8651 236.308 37.1974C235.859 37.5237 235.508 38.0007 235.255 38.6286C235.003 39.2564 234.877 40.0166 234.877 40.9091C234.877 41.8139 235 42.5833 235.246 43.2173C235.499 43.8513 235.852 44.3345 236.308 44.6669C236.763 44.9993 237.296 45.1655 237.905 45.1655C238.355 45.1655 238.758 45.0732 239.115 44.8885C239.478 44.7038 239.776 44.4361 240.01 44.0852C240.25 43.7282 240.407 43.3004 240.481 42.8018H244.193C244.131 43.8852 243.836 44.8393 243.307 45.6641C242.783 46.4827 242.06 47.1229 241.137 47.5845C240.214 48.0462 239.121 48.277 237.859 48.277ZM253.119 48.277C251.685 48.277 250.444 47.9723 249.398 47.3629C248.358 46.7474 247.554 45.8918 246.988 44.7962C246.422 43.6944 246.139 42.4171 246.139 40.9645C246.139 39.4995 246.422 38.2192 246.988 37.1236C247.554 36.0218 248.358 35.1662 249.398 34.5568C250.444 33.9413 251.685 33.6335 253.119 33.6335C254.553 33.6335 255.79 33.9413 256.831 34.5568C257.877 35.1662 258.683 36.0218 259.25 37.1236C259.816 38.2192 260.099 39.4995 260.099 40.9645C260.099 42.4171 259.816 43.6944 259.25 44.7962C258.683 45.8918 257.877 46.7474 256.831 47.3629C255.79 47.9723 254.553 48.277 253.119 48.277ZM253.137 45.2301C253.79 45.2301 254.335 45.0455 254.772 44.6761C255.209 44.3007 255.538 43.7898 255.759 43.1435C255.987 42.4972 256.101 41.7616 256.101 40.9368C256.101 40.112 255.987 39.3764 255.759 38.7301C255.538 38.0838 255.209 37.5729 254.772 37.1974C254.335 36.822 253.79 36.6342 253.137 36.6342C252.479 36.6342 251.925 36.822 251.475 37.1974C251.032 37.5729 250.697 38.0838 250.469 38.7301C250.247 39.3764 250.137 40.112 250.137 40.9368C250.137 41.7616 250.247 42.4972 250.469 43.1435C250.697 43.7898 251.032 44.3007 251.475 44.6761C251.925 45.0455 252.479 45.2301 253.137 45.2301ZM262.657 48V33.8182H266.59V48H262.657ZM264.632 31.9901C264.048 31.9901 263.546 31.7962 263.127 31.4084C262.715 31.0144 262.509 30.5436 262.509 29.9957C262.509 29.4541 262.715 28.9893 263.127 28.6016C263.546 28.2076 264.048 28.0107 264.632 28.0107C265.217 28.0107 265.716 28.2076 266.128 28.6016C266.547 28.9893 266.756 29.4541 266.756 29.9957C266.756 30.5436 266.547 31.0144 266.128 31.4084C265.716 31.7962 265.217 31.9901 264.632 31.9901ZM273.674 39.8011V48H269.741V33.8182H273.489V36.3203H273.655C273.969 35.4955 274.495 34.843 275.234 34.3629C275.973 33.8767 276.868 33.6335 277.921 33.6335C278.906 33.6335 279.764 33.849 280.497 34.2798C281.229 34.7107 281.799 35.3262 282.205 36.1264C282.611 36.9205 282.814 37.8684 282.814 38.9702V48H278.881V39.6719C278.887 38.804 278.666 38.1269 278.216 37.6406C277.767 37.1482 277.148 36.902 276.361 36.902C275.831 36.902 275.363 37.0159 274.957 37.2436C274.557 37.4714 274.243 37.8037 274.015 38.2408C273.794 38.6716 273.68 39.1918 273.674 39.8011Z"
      fill="#414141"
    />
    <path
      fill-rule="evenodd"
      clip-rule="evenodd"
      d="M240 195C275.899 195 305 165.899 305 130C305 94.1015 275.899 65 240 65C204.101 65 175 94.1015 175 130C175 165.899 204.101 195 240 195ZM240 183.182C269.371 183.182 293.182 159.372 293.182 130C293.182 100.628 269.371 76.8182 240 76.8182C210.628 76.8182 186.818 100.628 186.818 130C186.818 159.372 210.628 183.182 240 183.182ZM284.2 129.629C284.2 154.245 264.245 174.2 239.629 174.2C215.012 174.2 195.057 154.245 195.057 129.629C195.057 105.012 215.012 85.0571 239.629 85.0571C264.245 85.0571 284.2 105.012 284.2 129.629ZM239.629 111.242C241.819 110.251 243.343 108.046 243.343 105.486C243.343 101.998 240.516 99.1714 237.029 99.1714C233.541 99.1714 230.714 101.998 230.714 105.486C230.714 108.327 232.59 110.729 235.171 111.522V124.429L227.743 124.429L217.343 124.429V120.437C219.924 119.644 221.8 117.241 221.8 114.4C221.8 110.913 218.973 108.086 215.486 108.086C211.998 108.086 209.171 110.913 209.171 114.4C209.171 116.96 210.695 119.165 212.886 120.156V126.657C212.886 127.426 213.275 128.105 213.868 128.505C214.224 128.745 214.653 128.886 215.114 128.886L215.123 128.886H225.514V134.829H212.143C210.912 134.829 209.914 135.826 209.914 137.057V140.587C207.724 141.578 206.2 143.782 206.2 146.343C206.2 149.83 209.027 152.657 212.514 152.657C216.002 152.657 218.829 149.83 218.829 146.343C218.829 143.502 216.952 141.099 214.371 140.306V139.286H225.514V151.73C223.324 152.721 221.8 154.925 221.8 157.486C221.8 160.973 224.627 163.8 228.114 163.8C231.602 163.8 234.429 160.973 234.429 157.486C234.429 154.645 232.552 152.242 229.971 151.449V137.06V137.057V137.054V128.886L258.2 128.886V131.857H253.743L253.728 131.857C252.504 131.865 251.514 132.86 251.514 134.086V134.09V151.73C249.324 152.721 247.8 154.925 247.8 157.486C247.8 160.973 250.627 163.8 254.114 163.8C257.602 163.8 260.429 160.973 260.429 157.486C260.429 154.645 258.552 152.242 255.971 151.449V136.314L265.444 136.314C266.435 138.505 268.64 140.029 271.2 140.029C274.687 140.029 277.514 137.202 277.514 133.714C277.514 130.227 274.687 127.4 271.2 127.4C268.359 127.4 265.956 129.276 265.163 131.857H262.657V126.661L262.657 126.657L262.657 126.653V112.727C264.847 111.736 266.371 109.532 266.371 106.971C266.371 103.484 263.544 100.657 260.057 100.657C256.57 100.657 253.743 103.484 253.743 106.971C253.743 109.812 255.619 112.215 258.2 113.008V124.429H239.629V111.242Z"
      fill="#414141"
    />
    <path
      d="M205.745 230L200.334 211.091H204.701L207.831 224.229H207.988L211.441 211.091H215.181L218.625 224.257H218.791L221.921 211.091H226.288L220.877 230H216.981L213.38 217.637H213.233L209.641 230H205.745ZM230.874 230.268C229.97 230.268 229.163 230.111 228.455 229.797C227.747 229.477 227.187 229.006 226.775 228.384C226.369 227.756 226.166 226.975 226.166 226.039C226.166 225.251 226.31 224.589 226.6 224.054C226.889 223.518 227.283 223.088 227.781 222.761C228.28 222.435 228.846 222.189 229.48 222.023C230.12 221.857 230.791 221.74 231.493 221.672C232.318 221.586 232.983 221.506 233.487 221.432C233.992 221.352 234.358 221.235 234.586 221.081C234.814 220.927 234.928 220.699 234.928 220.398V220.342C234.928 219.758 234.743 219.305 234.374 218.985C234.011 218.665 233.493 218.505 232.823 218.505C232.115 218.505 231.551 218.662 231.133 218.976C230.714 219.284 230.437 219.671 230.302 220.139L226.664 219.844C226.849 218.982 227.212 218.237 227.754 217.609C228.295 216.975 228.994 216.489 229.85 216.151C230.711 215.806 231.708 215.634 232.841 215.634C233.629 215.634 234.383 215.726 235.103 215.911C235.829 216.095 236.473 216.381 237.033 216.769C237.599 217.157 238.045 217.656 238.372 218.265C238.698 218.868 238.861 219.591 238.861 220.435V230H235.131V228.033H235.02C234.792 228.477 234.488 228.867 234.106 229.206C233.724 229.538 233.266 229.8 232.73 229.991C232.195 230.175 231.576 230.268 230.874 230.268ZM232.001 227.553C232.579 227.553 233.09 227.439 233.533 227.212C233.977 226.978 234.324 226.664 234.577 226.27C234.829 225.876 234.955 225.43 234.955 224.931V223.426C234.832 223.506 234.663 223.58 234.448 223.648C234.238 223.709 234.001 223.768 233.737 223.823C233.472 223.872 233.207 223.919 232.943 223.962C232.678 223.999 232.438 224.032 232.222 224.063C231.761 224.131 231.358 224.239 231.013 224.386C230.668 224.534 230.4 224.734 230.21 224.987C230.019 225.233 229.923 225.54 229.923 225.91C229.923 226.445 230.117 226.855 230.505 227.138C230.899 227.415 231.398 227.553 232.001 227.553ZM245.846 211.091V230H241.912V211.091H245.846ZM252.93 211.091V230H248.996V211.091H252.93ZM262.543 230.277C261.085 230.277 259.829 229.982 258.776 229.391C257.73 228.794 256.924 227.95 256.357 226.861C255.791 225.765 255.508 224.469 255.508 222.974C255.508 221.515 255.791 220.235 256.357 219.133C256.924 218.031 257.721 217.172 258.749 216.557C259.783 215.941 260.995 215.634 262.386 215.634C263.322 215.634 264.193 215.784 264.999 216.086C265.812 216.381 266.52 216.828 267.123 217.425C267.732 218.022 268.206 218.773 268.545 219.678C268.883 220.576 269.053 221.629 269.053 222.835V223.915H257.078V221.478H265.35C265.35 220.912 265.227 220.41 264.981 219.973C264.735 219.536 264.393 219.194 263.956 218.948C263.525 218.696 263.024 218.57 262.451 218.57C261.854 218.57 261.325 218.708 260.863 218.985C260.408 219.256 260.051 219.622 259.792 220.084C259.533 220.539 259.401 221.047 259.395 221.607V223.925C259.395 224.626 259.524 225.233 259.783 225.744C260.047 226.254 260.42 226.648 260.9 226.925C261.38 227.202 261.949 227.341 262.608 227.341C263.045 227.341 263.445 227.279 263.808 227.156C264.171 227.033 264.482 226.848 264.741 226.602C264.999 226.356 265.196 226.054 265.332 225.697L268.97 225.938C268.785 226.812 268.406 227.575 267.834 228.227C267.268 228.874 266.535 229.378 265.636 229.741C264.744 230.098 263.713 230.277 262.543 230.277ZM279.163 215.818V218.773H270.622V215.818H279.163ZM272.561 212.42H276.494V225.642C276.494 226.005 276.55 226.288 276.661 226.491C276.771 226.688 276.925 226.827 277.122 226.907C277.325 226.987 277.559 227.027 277.824 227.027C278.009 227.027 278.193 227.012 278.378 226.981C278.563 226.944 278.704 226.916 278.803 226.898L279.421 229.825C279.224 229.886 278.947 229.957 278.59 230.037C278.233 230.123 277.799 230.175 277.288 230.194C276.341 230.231 275.51 230.105 274.796 229.815C274.088 229.526 273.537 229.077 273.143 228.467C272.749 227.858 272.555 227.089 272.561 226.159V212.42Z"
      fill="#414141"
    />
    <text
      x="365"
      y="40"
      font-family="Inter"
      font-size="20"
      fill="#414141"
      font-weight="bold"
    >
      Address
    </text>
    <rect x="350" y="54" width="110" height="110" fill="url(#pattern1)" />
    <g v-html="addressSVG" />
    <defs>
      <pattern
        id="pattern0"
        patternContentUnits="objectBoundingBox"
        width="1"
        height="1"
      >
        <use xlink:href="#imageSecret" transform="scale(0.00609756)" />
      </pattern>
      <pattern
        id="pattern1"
        patternContentUnits="objectBoundingBox"
        width="1"
        height="1"
      >
        <use xlink:href="#imageAddress" transform="scale(0.00609756)" />
      </pattern>
      <image id="imageSecret" width="164" height="164" :xlink:href="QRSecret" />
      <image
        id="imageAddress"
        width="164"
        height="164"
        :xlink:href="QRAddress"
      />
    </defs>
  </svg>
</template>

<style scoped></style>
